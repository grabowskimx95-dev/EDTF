"""
DTF_Sovereign_Installer.py
================================================================================
VERSION: V100 (Sovereign Class)
ARCHITECT: DTF Command
DESCRIPTION: Deploys the full modular directory tree for DTF Empire.
================================================================================
"""

import os
import sys

# =========================
# CONFIGURATION
# =========================
ROOT_DIR = "DTF_Empire"

# =========================
# FILE CONTENTS (MODULARIZED)
# =========================

# 1. ENGINE / MAIN.PY
CODE_MAIN = r'''import time
import logging
import sys
import os

# Add root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from engine.config import load_secrets
from engine.database_manager import init_db, get_pending_job, mark_job_status
from engine.logger_utils import setup_logging

# Agents
from agents.fact_checker import check_facts
from agents.content_generator import generate_content
from agents.video_composer import render_video
from agents.distribution_manager import publish_to_wp
from agents.cost_accountant import track_cost

def run_engine():
    setup_logging()
    logging.info("üëë DTF SOVEREIGN ENGINE ONLINE")
    init_db()
    
    while True:
        secrets = load_secrets()
        if not secrets.get("openai_key"):
            logging.warning("üîë Missing API Keys. Sleeping...")
            time.sleep(30)
            continue
            
        job = get_pending_job()
        if job:
            pid, name, link = job
            logging.info(f"üî® Starting Job: {name}")
            
            # --- PHASE 1: INTELLIGENCE ---
            facts = check_facts(name, secrets)
            
            # --- PHASE 2: CREATION ---
            content_pack = generate_content(name, facts, secrets)
            
            if content_pack:
                # --- PHASE 3: MEDIA ---
                # Saves to local 'packets' folder usually
                media_paths = render_video(name, content_pack['script'], secrets)
                
                # --- PHASE 4: DISTRIBUTION ---
                publish_to_wp(name, content_pack['html'], link, media_paths, secrets)
                
                # --- PHASE 5: ACCOUNTING ---
                # Estimate cost (approximate)
                track_cost("OpenAI_GPT4", 0.06) 
                
                mark_job_status(pid, "Published")
                logging.info(f"‚úÖ COMPLETED: {name}")
            else:
                mark_job_status(pid, "Failed")
                logging.error(f"‚ùå FAILED: {name}")
        else:
            logging.info("üí§ Idle. Waiting for jobs...")
            time.sleep(60)

if __name__ == "__main__":
    run_engine()
'''

# 2. ENGINE / DATABASE_MANAGER.PY
CODE_DB = r'''import sqlite3
import os
from datetime import datetime

DB_PATH = os.path.join(os.path.dirname(os.path.dirname(__file__)), "data", "empire.db")

def get_conn():
    os.makedirs(os.path.dirname(DB_PATH), exist_ok=True)
    return sqlite3.connect(DB_PATH, timeout=30)

def init_db():
    conn = get_conn()
    c = conn.cursor()
    c.execute("""CREATE TABLE IF NOT EXISTS posts (
        id INTEGER PRIMARY KEY,
        name TEXT UNIQUE,
        niche TEXT,
        link TEXT,
        status TEXT,
        app_url TEXT,
        created_at TEXT
    )""")
    c.execute("""CREATE TABLE IF NOT EXISTS ledger (
        id INTEGER PRIMARY KEY,
        item TEXT,
        cost REAL,
        timestamp TEXT
    )""")
    conn.commit()
    conn.close()

def get_pending_job():
    conn = get_conn()
    c = conn.cursor()
    c.execute("SELECT id, name, link FROM posts WHERE status='Ready' LIMIT 1")
    row = c.fetchone()
    conn.close()
    return row

def mark_job_status(pid, status):
    conn = get_conn()
    conn.cursor().execute("UPDATE posts SET status=? WHERE id=?", (status, pid)).connection.commit()
    conn.close()
'''

# 3. AGENTS / CONTENT_GENERATOR.PY
CODE_CONTENT = r'''import json
import requests

def generate_content(product, facts, secrets):
    """Tier-2 Writer Logic"""
    key = secrets.get("openai_key")
    if not key: return None
    
    prompt = f"""
    ROLE: DTF Command Lead Editor.
    TASK: Write a review for {product} based on these facts: {facts}
    OUTPUT: JSON with 'html' (blog post) and 'script' (30s video script).
    """
    
    try:
        r = requests.post(
            "https://api.openai.com/v1/chat/completions",
            headers={"Authorization": f"Bearer {key}"},
            json={
                "model": "gpt-4o",
                "messages": [{"role": "user", "content": prompt}],
                "response_format": {"type": "json_object"}
            }
        )
        return json.loads(r.json()["choices"][0]["message"]["content"])
    except Exception as e:
        print(f"Content Gen Error: {e}")
        return None
'''

# 4. AGENTS / COST_ACCOUNTANT.PY
CODE_CFO = r'''import sqlite3
import os
from datetime import datetime

DB_PATH = os.path.join(os.path.dirname(os.path.dirname(__file__)), "data", "empire.db")

def track_cost(service, cost):
    """Logs API spend to the ledger."""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.cursor().execute(
            "INSERT INTO ledger (item, cost, timestamp) VALUES (?, ?, ?)",
            (service, cost, datetime.utcnow().isoformat())
        )
        conn.commit()
        conn.close()
    except:
        pass
'''

# 5. DASHBOARD / COMMAND_HQ_GLASS.PY
CODE_DASH = r'''import streamlit as st
import sqlite3
import pandas as pd
import os

st.set_page_config(page_title="DTF Command HQ", layout="wide")

DB_PATH = os.path.join("..", "data", "empire.db")

def load_data():
    if not os.path.exists(DB_PATH): return pd.DataFrame()
    conn = sqlite3.connect(DB_PATH)
    df = pd.read_sql("SELECT * FROM posts", conn)
    conn.close()
    return df

st.title("üõ°Ô∏è DTF Command HQ (Glass)")

df = load_data()
if not df.empty:
    pending = len(df[df['status']=='Pending'])
    ready = len(df[df['status']=='Ready'])
    st.metric("Jobs Queued", ready, delta=pending)
    st.dataframe(df)
else:
    st.warning("Database empty or initializing...")
'''

# 6. CONFIG & UTILS
CODE_CONFIG = r'''import toml
import os

def load_secrets():
    path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "config", "secrets.toml")
    if os.path.exists(path):
        return toml.load(path)
    return {}
'''

CODE_LOGGER = r'''import logging
import os

def setup_logging():
    log_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), "logs")
    os.makedirs(log_dir, exist_ok=True)
    logging.basicConfig(
        filename=os.path.join(log_dir, "empire_activity.log"),
        level=logging.INFO,
        format="%(asctime)s [%(levelname)s] %(message)s"
    )
'''

# 7. AGENT PLACEHOLDERS (For Completeness)
CODE_VIDEO = r'''def render_video(name, script, secrets):
    # Placeholder for MoviePy logic
    return None
'''

CODE_FACTS = r'''def check_facts(name, secrets):
    return f"Technical specs for {name}"
'''

CODE_DISTRO = r'''def publish_to_wp(name, html, link, media, secrets):
    print(f"Simulating publish for {name} to WP...")
    return True
'''

# 8. LAUNCHERS
CODE_BAT = r'''@echo off
TITLE DTF SOVEREIGN ENGINE
cd engine
start /B python main.py
cd ../dashboard
streamlit run command_hq_glass.py
'''

# =========================
# INSTALLATION LOGIC
# =========================

STRUCTURE = {
    "orchestrator": ["master_rules.txt"],
    "engine": {
        "main.py": CODE_MAIN,
        "config.py": CODE_CONFIG,
        "database_manager.py": CODE_DB,
        "logger_utils.py": CODE_LOGGER
    },
    "agents": {
        "trend_hunter.py": "# Logic to fetch trends",
        "content_generator.py": CODE_CONTENT,
        "video_composer.py": CODE_VIDEO,
        "distribution_manager.py": CODE_DISTRO,
        "fact_checker.py": CODE_FACTS,
        "cost_accountant.py": CODE_CFO
    },
    "dashboard": {
        "command_hq_glass.py": CODE_DASH
    },
    "data": {},
    "logs": {},
    "installers": {},
    "prompts": ["chatgpt_system_prompt.txt", "gemini_system_prompt.txt"],
    "docs": ["MASTER_MANIFEST.txt", "ARCHITECTURE.md"],
    "archive": {},
    "config": {
        "secrets.toml": "openai_key=''\nwp_url=''"
    }
}

def create_structure(base, structure):
    for name, content in structure.items():
        path = os.path.join(base, name)
        
        if isinstance(content, dict):
            # It's a directory
            os.makedirs(path, exist_ok=True)
            create_structure(path, content)
        elif isinstance(content, list):
            # Directory with empty placeholder files
            os.makedirs(path, exist_ok=True)
            for file_name in content:
                with open(os.path.join(path, file_name), "w") as f:
                    f.write("")
        else:
            # It's a file
            with open(path, "w", encoding="utf-8") as f:
                f.write(content)

def install():
    print(f"üè∞ BUILDING DTF SOVEREIGN ARCHITECTURE...")
    if os.path.exists(ROOT_DIR):
        print(f"‚ö†Ô∏è  Warning: '{ROOT_DIR}' already exists.")
    
    os.makedirs(ROOT_DIR, exist_ok=True)
    create_structure(ROOT_DIR, STRUCTURE)
    
    # Write the root launcher
    with open(os.path.join(ROOT_DIR, "LAUNCH_SOVEREIGN.bat"), "w") as f:
        f.write(CODE_BAT)

    print(f"‚úÖ DEPLOYMENT COMPLETE.")
    print(f"üìÇ Root: {os.path.abspath(ROOT_DIR)}")
    print("üëâ ACTION: Edit 'config/secrets.toml' then run 'LAUNCH_SOVEREIGN.bat'")

if __name__ == "__main__":
    install()
